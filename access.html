<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GARDA SÍOCHÁNA — Investigator Access Portal</title>
<style>
  :root{--bg:#07101a;--panel:#0b1620;--accent:#b71c1c;--ink:#e6eef6;--muted:#9fb3c9;--line:rgba(255,255,255,.04)}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#061018,#07101a);color:var(--ink)}
  .wrap{max-width:980px;margin:32px auto;padding:18px}
  .banner{background:#0b0b0b;border-left:6px solid var(--accent);padding:12px 16px;font-weight:800}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--line);border-radius:10px;padding:18px;margin-top:16px}
  .grid{display:grid;grid-template-columns:1fr 340px;gap:18px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  label.small{font-size:13px;color:var(--muted)}
  .pwbox{display:flex;gap:8px;margin-top:12px}
  input[type="password"]{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:#071624;color:var(--ink);font-size:15px}
  button{background:var(--accent);color:white;border:none;padding:9px 12px;border-radius:8px;cursor:pointer}
  .secondary{background:#0f2a38;border:1px solid rgba(255,255,255,.03);color:var(--muted);padding:8px 10px;border-radius:8px;text-decoration:none;display:inline-block}
  .audit{background:#061426;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.03);font-size:13px;color:var(--muted);white-space:pre-wrap}
  .locked{background:#2c1b1b;color:#ffdede;padding:10px;border-radius:8px;margin-top:12px}
  .ok{background:#102b1f;color:#bff0c9;padding:10px;border-radius:8px;margin-top:12px}
  .footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="banner">GARDA SÍOCHÁNA — SECURE DATABASE PORTAL
      <div style="font-size:13px;color:var(--muted)">CASE FILE CS6849 — AUTHORIZED PERSONNEL ONLY</div>
    </div>

    <div class="panel">
      <div class="grid">
        <div>
          <h2>Investigator Access</h2>
          <p style="color:var(--muted)">Enter your investigator access code below to proceed to the restricted evidence portal.</p>

          <div class="pwbox">
            <input id="code" type="password" placeholder="Access code (investigators only)" autocomplete="off" />
            <button id="submit">Enter</button>
          </div>

          <div id="msg" class="locked" style="display:none"></div>

          <div style="margin-top:12px">
            <a class="secondary" href="index.html">Return to Case File — Open Catalogue</a>
          </div>

          <p class="small" style="margin-top:10px;color:var(--muted)">Successful authentication will forward you to the restricted evidence portal.</p>
        </div>

        <aside>
          <h4 style="margin:0 0 8px 0;color:var(--muted)">Authentication — Investigator</h4>
          <div style="color:var(--muted);font-size:13px">Access Level: <strong>RESTRICTED</strong></div>
          <div style="color:var(--muted);font-size:13px;margin-top:8px">Case ID: <strong>CS6849</strong></div>
          <div style="color:var(--muted);font-size:13px;margin-top:12px">Audit log (local):</div>
          <div id="audit" class="audit" aria-live="polite">No attempts yet.</div>

          <div style="margin-top:12px;color:var(--muted)">After <strong>3</strong> failed attempts the portal will lock for <strong>5 minutes</strong>.</div>
        </aside>
      </div>

      <div class="footer">All access attempts are recorded.</div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', ()=> {
  // CONFIG: change storedHash to the SHA256 hex of a new password if you want a different code.
  const storedHash = "ce6e39b1818c7a82e5fdc8c3d62bea96b2927ec7b71eca1c845d5ceeebeb27d4"; // SHA256("murder123")
  const redirectTo = "restricted.html";
  const maxAttempts = 3;
  const lockSeconds = 300; // 5 minutes

  const input = document.getElementById('code');
  const btn = document.getElementById('submit');
  const auditEl = document.getElementById('audit');
  const msg = document.getElementById('msg');

  // persisted state keys
  const KEY_ATT = 'cs6849_attempts';
  const KEY_LOCK = 'cs6849_lockedUntil';
  const KEY_AUD = 'cs6849_audit';

  // read persisted state
  let attempts = parseInt(localStorage.getItem(KEY_ATT) || '0', 10) || 0;
  let lockedUntil = parseInt(localStorage.getItem(KEY_LOCK) || '0', 10) || 0;

  console.info('Access portal loaded. attempts=', attempts, 'lockedUntil=', lockedUntil);

  // Initialize audit display
  auditEl.textContent = localStorage.getItem(KEY_AUD) || 'No attempts yet.';

  function pushAudit(line) {
    const now = new Date().toLocaleString();
    const entry = `${now} — ${line}`;
    const cur = (localStorage.getItem(KEY_AUD) || '').trim();
    const next = entry + (cur ? '\n' + cur : '');
    localStorage.setItem(KEY_AUD, next);
    auditEl.textContent = next;
  }

  // update lock UI; returns true if locked
  let lockTimer = null;
  function updateLockDisplay() {
    const now = Date.now();
    if (lockedUntil && now < lockedUntil) {
      const remaining = Math.max(0, Math.ceil((lockedUntil - now) / 1000));
      const mins = Math.floor(remaining / 60);
      const secs = remaining % 60;
      msg.style.display = '';
      msg.className = 'locked';
      msg.textContent = `Portal locked: ${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')} remaining.`;
      input.disabled = true;
      btn.disabled = true;
      return true;
    } else {
      msg.style.display = 'none';
      input.disabled = false;
      btn.disabled = false;
      return false;
    }
  }

  function setLock(seconds) {
    lockedUntil = Date.now() + seconds * 1000;
    localStorage.setItem(KEY_LOCK, String(lockedUntil));
    localStorage.setItem(KEY_ATT, '0');
    attempts = 0;
    pushAudit('LOCKED — too many failed attempts');
    if (lockTimer) clearInterval(lockTimer);
    lockTimer = setInterval(()=> {
      if (!updateLockDisplay()) {
        clearInterval(lockTimer);
        lockedUntil = 0;
        localStorage.removeItem(KEY_LOCK);
        pushAudit('LOCK EXPIRED');
      }
    }, 1000);
    updateLockDisplay();
  }

  updateLockDisplay();

  // SHA-256 helper: prefer crypto.subtle, otherwise dynamic fallback to CryptoJS (CDN)
  async function sha256hex(msg) {
    // prefer native Subtle API
    if (window.crypto && crypto.subtle && typeof crypto.subtle.digest === 'function') {
      try {
        const enc = new TextEncoder();
        const data = enc.encode(msg);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      } catch (e) {
        console.warn('crypto.subtle.digest failed:', e);
        // fall through to fallback
      }
    }

    // fallback: ensure CryptoJS is loaded, then compute
    if (window.CryptoJS && CryptoJS.SHA256) {
      return CryptoJS.SHA256(msg).toString(CryptoJS.enc.Hex);
    }

    // load CryptoJS dynamically
    await new Promise((resolve, reject) => {
      const src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
      if (document.querySelector('script[src="'+src+'"]')) {
        // already in DOM but not ready? give it a beat
        setTimeout(resolve, 200);
        return;
      }
      const s = document.createElement('script');
      s.src = src;
      s.crossOrigin = 'anonymous';
      s.onload = ()=> resolve();
      s.onerror = (e)=> reject(new Error('Failed to load CryptoJS: ' + e));
      document.head.appendChild(s);
    });

    if (window.CryptoJS && CryptoJS.SHA256) {
      return CryptoJS.SHA256(msg).toString(CryptoJS.enc.Hex);
    }
    throw new Error('No hashing available');
  }

  btn.addEventListener('click', async ()=> {
    // if locked, show remaining
    if (lockedUntil && Date.now() < lockedUntil) {
      updateLockDisplay();
      console.warn('Attempt while locked.');
      return;
    }

    const value = (input.value || '').trim();
    if (!value) {
      msg.style.display = '';
      msg.className = 'locked';
      msg.textContent = 'Enter a valid access code.';
      return;
    }

    btn.disabled = true;
    try {
      const h = await sha256hex(value);
      console.info('Computed hash:', h);
      if (h === storedHash) {
        pushAudit('SUCCESS');
        localStorage.setItem(KEY_ATT, '0');
        msg.style.display = '';
        msg.className = 'ok';
        msg.textContent = 'Access granted — redirecting…';
        setTimeout(()=> window.location.href = redirectTo, 700);
      } else {
        attempts = (parseInt(localStorage.getItem(KEY_ATT) || '0', 10) || 0) + 1;
        localStorage.setItem(KEY_ATT, String(attempts));
        pushAudit(`FAILED attempt ${attempts}`);
        console.warn('Incorrect code. attempts=', attempts);
        msg.style.display = '';
        msg.className = 'locked';
        msg.textContent = 'Incorrect access code.';
        input.value = '';
        input.focus();
        if (attempts >= maxAttempts) {
          setLock(lockSeconds);
        }
      }
    } catch (err) {
      console.error('Error while verifying code:', err);
      msg.style.display = '';
      msg.className = 'locked';
      msg.textContent = 'Technical error — see browser console.';
    } finally {
      btn.disabled = false;
    }
  });

  input.addEventListener('keyup', (e)=> { if (e.key === 'Enter') btn.click(); });

  // quick debug message to console
  (async ()=> {
    try {
      const test = await sha256hex('murder123');
      console.info('SHA256 test (murder123) =>', test);
    } catch(e) {
      console.warn('SHA256 test failed; fallback not available. Error:', e);
    }
  })();

});
</script>
</body>
</html>
